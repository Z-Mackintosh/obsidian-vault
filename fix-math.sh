#!/bin/bash

# fix-math.sh - ç²¾ç®€ / ä¿®å¤ / Linux ä¸“ç”¨ç‰ˆ
# åŠŸèƒ½ï¼š
#   1. ä¿®å¤ $ a $ â†’ $a$
#   2. å°† \[ \] å’Œ \] â†’ $$
#   3. å°† \( \) â†’ $
#   4. æ”¯æŒ fzf å¤šæ–‡ä»¶äº¤äº’é€‰æ‹©
# ç‰¹ç‚¹ï¼šåŸºäºä½ åŸè„šæœ¬ï¼ŒåªåŠ  fzfï¼Œä¸é‡æ„é€»è¾‘

# æ£€æŸ¥ä¾èµ–
command -v fzf >/dev/null 2>&1 || { echo "â— è¯·å…ˆå®‰è£… fzf"; exit 1; }

# -------------------------------
# æ–‡ä»¶é€‰æ‹©é€»è¾‘ï¼ˆä¼˜å…ˆå‚æ•°ï¼Œæ— åˆ™è°ƒç”¨ fzfï¼‰
# -------------------------------

files=()

if [[ $# -eq 0 ]]; then
    # äº¤äº’é€‰æ‹©
    echo "ğŸ” å¯åŠ¨ fzf æ–‡ä»¶é€‰æ‹©..."
    readarray -t files < <(fd -e md 2>/dev/null || find . -name "*.md")
    if [[ ${#files[@]} -eq 0 ]]; then
        echo "âŒ æœªæ‰¾åˆ°ä»»ä½• .md æ–‡ä»¶"
        exit 1
    fi
    mapfile -t selected_files < <(printf '%s\n' "${files[@]}" | fzf --multi --prompt="é€‰æ‹©è¦å¤„ç†çš„æ–‡ä»¶ > ")
    files=("${selected_files[@]}")
else
    files=("$@")
fi

# -------------------------------
# å¦‚æœæ²¡æœ‰é€‰ä¸­ä»»ä½•æ–‡ä»¶ï¼Œé€€å‡º
# -------------------------------

if [[ ${#files[@]} -eq 0 ]]; then
    echo "âŒ æœªé€‰æ‹©æ–‡ä»¶ï¼Œé€€å‡ºã€‚"
    exit 1
fi

# -------------------------------
# è¿­ä»£å¤„ç†æ¯ä¸ªæ–‡ä»¶
# -------------------------------

for file in "${files[@]}"; do
    [[ -f "$file" ]] || { echo "âš ï¸ è·³è¿‡ä¸å­˜åœ¨æ–‡ä»¶: $file"; continue; }

    echo "ğŸ“„ æ­£åœ¨å¤„ç†: $file"

    # å¤‡ä»½åŸæ–‡ä»¶
    cp "$file" "$file.backup.$(date '+%Y%m%d%H%M%S')"

    # 1. ä¿®å¤ $ a $ -> $a$
    sed -E -i 's/\$[[:space:]]+([^$]+)[[:space:]]+\$/\$\1\$/g' "$file"

    # 2. ä¿®å¤ \[ å’Œ \]ï¼š
    sed -E -i 's/^\\\[\s*$/$$/g'      "$file"  # å•ç‹¬ä¸€è¡Œ \[
    sed -E -i 's/^\\\]\s*$/$$/g'      "$file"  # å•ç‹¬ä¸€è¡Œ \]
    sed -E -i 's/\\\[/$$/g'           "$file"  # è¡Œå†… \[
    sed -E -i 's/\\\]/$$/g'           "$file"  # è¡Œå†… \]

    # 3. ä¿®å¤ \( å’Œ \) -> $
    sed -E -i 's/\\\(/\\$/g'          "$file"
    sed -E -i 's/\\\)/\\$/g'          "$file"

    # æç¤ºæˆåŠŸ & æ˜¾ç¤ºå…¬å¼ä¸Šä¸‹æ–‡
    echo "âœ… å·²ä¿®å¤ï¼š$file"
    bat --style=numbers --pager=never "$file" | grep -E '(\$.*\$|\\\[|\\\]|\$$)' || true
done

echo "ğŸ‰ æ‰€æœ‰æ–‡ä»¶å¤„ç†å®Œæˆã€‚"
